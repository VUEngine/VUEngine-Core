/*
 * VUEngine Core
 *
 * © Jorge Eremiev <jorgech3@gmail.com> and Christian Radke <c.radke@posteo.de>
 *
 * For the full copyright and license information, please view the LICENSE file
 * that was distributed with this source code.
 */

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
// INCLUDES
//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

#include <Singleton.h>

#include "SRAMManager.h"

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
// CLASS' ATTRIBUTES
//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

extern uint32 _sramBssEnd;

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
// CLASS' MACROS
//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

#define	__SRAM_ACCESS_DELAY				200
#define	__SRAM_DUMMY_READ_CYCLES		8
#define	__SRAM_DUMMY_READ_LENGTH		100

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
// CLASS' PUBLIC STATIC METHODS
//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

static void SRAMManager::save(const BYTE* const source, int32 memberOffset, int32 dataSize)
{
	SRAMManager sramManager = SRAMManager::getInstance();

	uint16* destination = sramManager->spaceAddress + memberOffset;
	ASSERT(0 == ((int32)destination % 2), "SRAMManager::save: odd destination");

	for(int32 i = 0; i < dataSize; i++)
	{
		destination[i] = source[i];
	}
}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

static void SRAMManager::read(BYTE* destination, int32 memberOffset, int32 dataSize)
{
	SRAMManager sramManager = SRAMManager::getInstance();

	uint16* source = sramManager->spaceAddress + memberOffset;
	ASSERT(0 == ((int32)source % 2), "SRAMManager::constructor: odd source");

	for(int32 i = 0; i < dataSize; i++)
	{
		destination[i] = source[i] & 0x00FF;
	}
}
//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
// CLASS' PUBLIC METHODS
//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

secure void SRAMManager::reset()
{
	// Dummy, don't remove
}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
// CLASS' PRIVATE METHODS
//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

void SRAMManager::constructor()
{
	// Always explicitly call the base's constructor 
	Base::constructor();

	this->spaceAddress = (uint16*)&_sramBssEnd;

	SRAMManager::initialize(this);
}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

void SRAMManager::destructor()
{
	// Always explicitly call the base's destructor 
	Base::destructor();
}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

void SRAMManager::initialize()
{
	for(int16 i = __SRAM_DUMMY_READ_CYCLES; 0 <= i--;)
	{
		uint16 dummyChar[__SRAM_DUMMY_READ_LENGTH];

		SRAMManager::read((BYTE*)&dummyChar, i, sizeof(dummyChar));
	}
}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

