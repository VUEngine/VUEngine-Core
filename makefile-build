# Engine name
ENGINE_NAME = vuengine/core

# Engine's home
ENGINE_HOME = $(VBDE)libs/$(ENGINE_NAME)

include $(ENGINE_HOME)/makefile-common

build: test phony $(C_OBJECTS) $(C_INTERMEDIATE_SOURCES) $(ASSEMBLY_OBJECTS) $(SETUP_CLASSES_OBJECT).o $(FINAL_SETUP_CLASSES_OBJECT).o

test:
	@echo OPTIMIZATION_OPTION $(OPTIMIZATION_OPTION)

$(SETUP_CLASSES_OBJECT).o: $(SETUP_CLASSES_SOURCE).c
	@bash $(ENGINE_HOME)/lib/compiler/preprocessor/printCompilingInfo.sh $<
	@$(GCC) -Wp,-MD,$*.dd $(foreach INC,$(FINAL_INCLUDE_PATHS),-I$(INC))\
        $(foreach MACRO,$(MACROS),-D$(MACRO)) $(C_PARAMS) -$(COMPILER_OUTPUT) $< -o $@
	@sed -e '1s/^\(.*\)$$/$(subst /,\/,$(dir $@))\1/' $*.dd > $*.d
	@rm -f $*.dd

$(FINAL_SETUP_CLASSES_OBJECT).o: $(FINAL_SETUP_CLASSES_SOURCE).c
	@bash $(ENGINE_HOME)/lib/compiler/preprocessor/printCompilingInfo.sh $<
	@$(GCC) -Wp,-MD,$*.dd $(foreach INC,$(FINAL_INCLUDE_PATHS),-I$(INC))\
        $(foreach MACRO,$(MACROS),-D$(MACRO)) $(C_PARAMS) -$(COMPILER_OUTPUT) $< -o $@
	@sed -e '1s/^\(.*\)$$/$(subst /,\/,$(dir $@))\1/' $*.dd > $*.d
	@rm -f $*.dd

# Rule for creating object file and .d file, the sed magic is to add the object path at the start of the file
# because the files gcc outputs assume it will be in the same dir as the source file.
$(STORE)/objects/$(NAME)/%.o: $(WORKING_FOLDER)/objects/$(NAME)/%.c
	@$(GCC) -Wp,-MD,$(STORE)/objects/$(NAME)/$*.dd $(foreach INC,$(FINAL_INCLUDE_PATHS),-I$(INC))\
        $(foreach MACRO,$(MACROS),-D$(MACRO)) $(C_PARAMS) -$(COMPILER_OUTPUT) $< -o $@ 2>&1 | bash $(ENGINE_HOME)/lib/compiler/preprocessor/processGCCOutput.sh -w $(WORKING_FOLDER) -np $(VBDE)libs -n $(NAME) -lp $(VBDE)libs -l $(PLUGINS)
	@sed -e '1s/^\(.*\)$$/$(subst /,\/,$(dir $@))\1/' $(STORE)/objects/$(NAME)/$*.dd > $(STORE)/objects/$(NAME)/$*.dd.tmp 
	@sed -e 's#$<##' $(STORE)/objects/$(NAME)/$*.dd.tmp > $(STORE)/objects/$(NAME)/$*.dd
	@sed -e 's#$@#$<#' $(STORE)/objects/$(NAME)/$*.dd > $(STORE)/objects/$(NAME)/$*.d.tmp
	@sed -e '/^[ 	\\]*$$/d' $(STORE)/objects/$(NAME)/$*.d.tmp > $(STORE)/objects/$(NAME)/$*.d
	@rm -f $(STORE)/objects/$(NAME)/$*.dd
	@rm -f $(STORE)/objects/$(NAME)/$*.dd.tmp
	@rm -f $(STORE)/objects/$(NAME)/$*.d.tmp

$(WORKING_FOLDER)/objects/$(NAME)/%.c: $(MY_HOME)/%.c
	@bash $(ENGINE_HOME)/lib/compiler/preprocessor/processSourceFile.sh -i $< -o $@ -d -w $(WORKING_FOLDER) -c $(CLASSES_HIERARCHY_FILE)

$(STORE)/objects/$(NAME)/%.o: $(MY_HOME)/%.s
	@bash $(ENGINE_HOME)/lib/compiler/preprocessor/printCompilingInfo.sh $<
	@$(AS) -o $@ $<

